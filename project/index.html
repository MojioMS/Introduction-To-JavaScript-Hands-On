<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1"/>


<style type="text/css">
	
	html, body { 
        height:100%;
		max-width: 100%;
		overflow-x:hidden;
    }
    #map {
        height:100%;
        border: 2px dashed black;
    }	  
	#mapbottom {
        height:100%;
        border: 2px dashed black;
    }	  
	#bodytopcontainer {
		height:80%;
		padding-bottom: 20px;
	}
	#bodycontainerbottom{
		height:75%;
	}
	#mapcontainer {
		height: 90%;
	}
	#mapcontainerbottom {
		height: 85%;
	}
	.timeContainerAbsolute {
		background:lightblue;
	}
	#sliderabs .slider-track-high, #sliderrel .slider-track-high, #sliderrel .slider-track-low {
		background:yellow;
	}
	#sliderabs .slider-selection {
		background:yellow;
	}
	#sliderabs .slider-tick, #sliderrel .slider-tick {
		background:yellow;
	}
	#sliderrel .slider-tick.in-selection{
		background: lightblue;
	}
	.info-box {
		padding: 5px 5px;
		font: 14px/16px Arial, Helvetica, sans-serif;
		background: white;
		background: rgba(255,255,255,0.8);
		border-radius: 5px;
	}
	.info h4 {
		margin: 0 0 5px;
		color: #777;
	}#legend-top {
		position: relative;
	}#legend-top-max {
		position: absolute;
		right: 0;
	}#legend-top-min {
		position: absolute;
		left: 0;
	}#legend-top-mid {
		position: absolute;
		left: 48%;
	}
/**
	.legend {
		line-height: 18px;
		color: #555;
	}
	.legend i {
		float: left;
		margin-right: 8px;
		opacity: 0.7;
	}*/
	
	
</style>


<link href="bootstrap-slider-master/dependencies/css/bootstrap.min.css" rel="stylesheet" />
<link href="bootstrap-slider-master/css/bootstrap-slider.css" rel="stylesheet" />
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<link rel="stylesheet" type="text/css" href="http://www.shieldui.com/shared/components/latest/css/light/all.min.css" />
<link href="intro.js-2.0/intro.js-2.0/introjs.css" rel="stylesheet" />

<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script type='text/javascript' src="bootstrap-slider-master/dependencies/js/jquery.min.js"></script>
<script type='text/javascript' src="bootstrap-slider-master/js/bootstrap-slider.js"></script>
<script src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="Chart.js-2.0.0-beta/Chart.js-2.0.0-beta/Chart.js" type="text/javascript"></script>
<script src="intro.js-2.0/intro.js-2.0/intro.js" type="text/javascript"></script>


<title>Employees</title>
</head>

<body role="document">
	<!-- Navigation Bar -->
    <nav class="navbar navbar-inverse" >
            <div class="navbar-header">
                <a class="navbar-brand" id="date"></a>
            </div>
            <div>
                <ul class="nav navbar-nav"
                	<li></li>
                    <li><button data-step="4" data-intro='You can allways get back to the Map-View by clicking on this button.'>Map</button></li>
                    <li><button data-step="3" data-intro='If you want to know what this website is all about, click here.'>About</button></li>
                    <li><button data-step="2" data-intro='If you want to see license information about this website and the licenses of used tools, click this button.'>License Information</button></li>
                    <li><button data-step="1" onclick="introJs().goToStep(1).start();" data-intro='Welcome! </br> If you need help, just click the Tutorial button for a step-by-step survey through the facilities of the website.'>Tutorial</button></li>
                </ul>
        </div>
    </nav> 
   
    <div class="container col-md-5 col-xs-12" id="info-box" data-step="5" data-intro='<strong>The Title</strong></br> You can read here which data is visualized.' data-position="bottom-right-aligned"><h4>Total employees subject to social insurance contributions in 2012</h4><br /><b>Hover over a district '</b>);</div>
    <div class="container col-md-3 col-xs-12" id="legend-top" style="height:10%; width:screen.witdh" data-step="6" data-intro='<strong>The legend</strong></br> The legend of the map is shown here. The values start from <strong> white </strong> and go up to <strong> blue </strong> continuously.'>
    	<div data-step="13" data-intro='The legend has changed now into a 2-color-ramp legend. Districts with a negative change of employees are visualized now in <strong>red</strong>, positive changes in <strong>blue</strong>. Have you forgotton to select <strong>...changes in years</strong>. Go "Back" and do it now!'>
            <img src="pictures/legend_top_relative.png" style="height:50%; width:100%; opacity:0.7; border:1px solid #333" id="img_legend">
            <p id="legend-top-max"> maximum </p>
            <p id="legend-top-mid"> middle </p>
            <p id="legend-top-min"> 0 </p>
        </div>
    </div>
    <div class="col-md-5"></div>
    <!-- upper body Container -->
    <div class="row" id="bodytopcontainer">
        
        <!-- Map Container -->
        <div class="panel panel-default col-md-8 col-xs-12" id="mapcontainer">
        	<div class="panel-default" style="height:100%">
            	<div id="map" data-step="7" data-intro='<strong> The map </strong> </br> The map shows districts of Muenster. The color of each district is corresponding to the legend. You can <strong>hover</strong> over a district to see additional information below the title. You can also <strong>click</strong> on a district to zoom into it.' data-position="right">	</div>
            </div>
        </div>
        <!-- User Interface Container -->
        <div class="panel panel-info col-md-4 col-xs-12" id="UIcontainer" data-step="8" data-intro='You can select options for the visualized data in this panel.' data-position="left">
                <div class="panel-heading">
                	<h3> Data option: </h3>
                </div>
        
                <!-- Selector: District or Subdistricts -->
                <div data-step="9" data-intro='You can select between showing districts or subdistricts.'> 
                    <div class="form-group">
                        <label for="sel_topDistrictLevel">Select district level:</label>
                    </div>
                    <div style="margin: 20px 0px 25px 0px;">
                        <select class="form-control" id="sel_topDistrictLevel" onchange="sel_topDistrictLevel()">
                            <option>Districts</option>
                            <option>Sub-districts</option>
                         </select>
                    </div>
                </div>
                
                <!-- Selector: Total, Male, Female, German, non-german, or  <25years -->
                <div data-step="10" data-intro='You can select between different categories of employees you want to have visualized.' data-position="left">
                    <div class="form-group">
                        <label for="sel_topCategory">Select data category: </label>
                    </div>
                    <div style="margin: 20px 0px 25px 0px;">
                        <select class="form-control" id="sel_topCategory" onchange="sel_topCategory()">
                            <option>Total</option>
                            <option>Male</option>
                            <option>Female</option>
                            <option>German</option>
                            <option>non-german</option>
                            <option>younger than 25 years</option>
                         </select>
                    </div>
                </div>
                
                <div>
                    <!-- Radio Buttons: show absolute values OR show changes -->
                    <div class="container">
                        <label for="sel_top_abs_rel">Show...</label>
                        <form role="form" id="sel_top_abs_rel" style="margin: 0px 0px 0px 30px;">
                            <label class="radio">
                                <input type="radio" name="optradio" onclick="timeAbsolute()" checked="checked">...absolute values
                            </label>
                            <label class="radio" data-step="12" data-intro='Are you interested into the changes of the districts? Select <strong>...changes in years</strong> now and press next' data-position="left">
                                <input type="radio" name="optradio" onclick="timeRelative()" >...changes in years
                            </label>
                        </form>
                    </div>
                    
                    <div data-step="11" data-intro='Select between different years of the data. Give it a try and select a different year!' data-position="top">
                        <!-- Timeline Selector(s): only one is shown at a time -->
                        <div id="timeContainerAbsolute" style="margin: 50px 0px 25px 30px;">
                             <input id="sliderabs" type="text"/> <!-- absolute timeline: 1 from {2010,2011,2012,2013,2014}-->
                        </div>
                        <div id="timeContainerRelative" style="margin: 50px 0px 25px 30px;" data-step="14" data-intro='Now you can select a Start- and End-year upon which the calculation of changes is based on. Do it and observe how the map and the legend changes.' data-position="top">
                             <input id="sliderrel" type="text"/> <!-- relative changes: 2 non-equal from {2010,2011,2012,2013,2014}-->
                        </div>
                    </div>
                </div>
            
            
        </div>
    </div>
    
    <!-- lower body container -->
    <div class="row" style="height: 100%">
    	<div class="col-md-12 col-xs-12 panel panel-primary" id="bodycontainerbottom" >
                <div class="panel-heading">
                	<h3> District and Subdistrict Comparision </h3>
                </div>
        <!-- Map Container Bottom-->
        <div class="col-md-5  col-xs-12" id="mapcontainerbottom">
            <div id="mapbottom"  data-step="15" data-intro='Shanka told me indians use <strong>Âçê</strong> to celebrate the "light", lolz.' data-position="right">	</div>
        </div>
        
        <!-- User Interface Container Bottom -->
        <div class="col-md-2  col-xs-12 panel panel-info" id="UIcontainerbottom">
            <div class="panel-heading">
                <h4> Comparison option: </h4>
            </div>
    
            <!-- Selector: District or Subdistricts -->
            <div class="form-group">
                <label for="sel_botDistrictLevel">Select district level:</label>
            </div>
            <div style="margin: 20px 0px 25px 0px;">
                <select class="form-control" id="sel_botDistrictLevel" onchange="sel_botDistrictLevel()">
                    <option onclick="show_districts()">Districts</option>
                    <option onclick="show_subdistricts()">Sub-districts</option>
                 </select>
            </div>
            
            <!-- Selector: Selection of Districts -->
            <div id="sel_dis">
                <div class="form-group"> 
                    <label for="sel_botDistricts">Select districts by clicking on them at the map or select them from the list below: </label>
                </div>
                <div style="margin: 20px 0px 25px 0px;" >
                    <select multiple class="form-control" id="sel_botDistricts" onchange="sel_botDistricts()">
                        <option>Xmple District 1</option>
                        <option>Xmple District 2</option>
                        <option>unknown</option>
                     </select>
                </div>
            </div>
            
            <!-- Selector: Selection of Subdistricts -->
            <div id="sel_subdis">
                <div class="form-group"> 
                    <label for="sel_botSubdistricts">Select subdistricts by clicking on them at the map or select them from the list below: </label>
                </div>
                <div style="margin: 20px 0px 25px 0px;">
                    <select multiple class="form-control" id="sel_botSubdistricts" onchange="sel_botSubdistricts()">
                     </select>
                </div>
            </div>
            
            <!-- Selector: Total, Male, Female, German, non-german, or  <25years -->
            <div class="form-group">
                <label for="sel_botCategory">Select data category: </label>
            </div>
            <div style="margin: 20px 0px 25px 0px;">
                <select class="form-control" id="sel_botCategory" onchange="sel_botCategory()">
                    <option>Total</option>
                    <option>Male</option>
                    <option>Female</option>
                    <option>German</option>
                    <option>non-german</option>
                    <option>younger than 25 years</option>
                 </select>
            </div>
        </div>
        
        <!-- detailChart -->
        <div class="col-md-5 col-xs-12 panel">
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 id="diagram_title_dis"> Districts in comparison:</h3>
                    <h3 hidden id="diagram_title_subdis"> Subdistricts in comparison: </h3>
                </div>
                <canvas id="myChart"></canvas>
                <div id="legend">
                </div>

        </div>
    </div>
    </div>
  
    
    </div>

</body>

<script>
	
	var data = {
		labels: ["2010", "2011", "2012", "2013", "2014"],
		datasets: [
			{
				label: "Example data Aegidii",
				fill: false,
				backgroundColor: "rgba(70,70,220,0.2)",
				borderColor: "rgba(70,70,220,1)",
				pointBorderColor: "rgba(70,70,220,1)",
				pointBackgroundColor: "#fff",
				pointBorderWidth: 1,
				pointHoverRadius: 5,
				pointHoverBackgroundColor: "rgba(70,70,220,1)",
				pointHoverBorderColor: "rgba(70,70,220,1)",
				pointHoverBorderWidth: 2,
				data: [65, 59, 80, 81, 56]
			},
			{
				label: "Example data Ueberwasser",
				fill: false,
				backgroundColor: "rgba(70,220,60,0.2)",
				borderColor: "rgba(70,220,60,1)",
				pointBorderColor: "rgba(70,220,60,1)",
				pointBackgroundColor: "#fff",
				pointBorderWidth: 1,
				pointHoverRadius: 5,
				pointHoverBackgroundColor: "rgba(70,220,60,1)",
				pointHoverBorderColor: "rgba(70,220,60,1)",
				pointHoverBorderWidth: 2,
				data: [-30, 48, 40, 19, 86]
			},
			{
				label: "Example data Buddenturm",
				fill: false,
				backgroundColor: "rgba(220,70,70,0.2)",
				borderColor: "rgba(220,70,70,1)",
				pointBorderColor: "rgba(220,70,70,1)",
				pointBackgroundColor: "#fff",
				pointBorderWidth: 1,
				pointHoverRadius: 5,
				pointHoverBackgroundColor: "rgba(220,70,70,1)",
				pointHoverBorderColor: "rgba(220,70,70,1)",
				pointHoverBorderWidth: 2,
				data: [61, 28, 46, 39, 53]
			}
			
		]
	};
	
	// Get the context of the canvas element we want to select
	var ctx = document.getElementById("myChart").getContext("2d");
	var myBarChart = new Chart(ctx, { type: 'bar', data:data, options: {}});
	document.getElementById("legend").innerHTML = myBarChart.generateLegend();

</script>

<!-- The following Script handles the triggers of the Top map User interfaces and updates the top map visualization -->
<script>

	window.onload = initialise;
	
	var maximum = 0;
	var ch_maximum = 0;
	var ch_minimum = 0;
	var geoJsonLayer;
	var drawnFirstTime = true;
	var topDataSelection$districtLevel = "districts";
	var	topDataSelection$category = "total";
	var	topDataSelection$dependency = "absolute";
	var	topDataSelection$year = 2012;
	var	topDataSelection$startingYear = 2010;
	var	topDataSelection$endingYear = 2012;
	var botDataSelection$districtLevel = "districts";
	var botDataSelection$category = "total";
	var botDataSelection$comparedDistricts = [];
	var botDataSelection$comparedSubdistricts = [];
	
	function rgbToHex(r, g, b) {
		return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
	}
	
	// FeatureCollection containing all subdistricts.
	var featureCollectionSubdistricts = {
		"type" : "FeatureCollection",
		"properties": {
			"districtLevel": "subdistricts"	
		},
		"features": [
				
		]
	}
	
	//prefixes for the query
	var prefixes = "\
		prefix lodcom: <http://vocab.lodcom.de/> \n\
		prefix dc: <http://purl.org/dc/elements/1.1/> \n\
		prefix geo: <http://www.opengis.net/ont/geosparql#> \n\
		prefix rdf: <http://www.w3.org/1999/02/22-rdf-syntax-ns#> \n\
		prefix rdfs: <http://www.w3.org/2000/01/rdf-schema#> \n\
		prefix xsd: <http://www.w3.org/2001/XMLSchema#> \n\
		prefix sparel: <http://www.ordnancesurvey.co.uk/docs/ontologies/spatialrelations.owl/>\n";
	// endpoint url
	var queryUrl = "http://giv-lodumdata.uni-muenster.de:8282/parliament/sparql?output=JSON&query=";
	var district = "aegidii";
	var subdistricts = ["aegidii","ueberwasser","dom","buddenturm","martini","pluggendorf","josef","bahnhof","hansaplatz","schlachthof","kreuz","neutor","schloss","aaseestadt","geist","schuetzenhof","hafen","rumphorst","uppenberg","gievenbeck","sentrup","mecklenbeck","albachten","roxel","nienberge","coerde","sprakel","handorf","angelmodde","wolbeck","berg_fidel","hiltrup-mitte","hiltrup-ost","hiltrup-west","mauritz-mitte","herz-jesu","kinderhaus-ost","kinderhaus-west","gelmer-dyckburg","gremmendorf-west","gremmendorf-ost","mauritz-ost","amelsbueren","duuesberg","mauritz-west"]; //duuesberg and mauritz-west dont work
	
	/**
	* initialise() sets up the default starting selection when the website in loaded.
	*/
	function initialise(){
		maximum = 0;
		ch_maximum = 0;
		ch_minimum = 0;
		topDataSelection$districtLevel = "districts";
		topDataSelection$category = "total";
		topDataSelection$dependency = "absolute";
		topDataSelection$year = 2012;
		topDataSelection$startingYear = 2010;
		topDataSelection$endingYear = 2012;
		botDataSelection$districtLevel = "districts";
		botDataSelection$category = "total";
		botDataSelection$comparedDistricts = [];
		botDataSelection$comparedSubdistricts = [];	
		subdistricts.forEach(function(entry){
			var district = entry;
			initQuery(district);
		});
		updateBotMap();
		updateTopMap();
		introJs().setOption('scrollToElement', true).start();
	}
     
	// Function which sends the query to the triple store and stores the data as result
	function queryTriplestore(query, district) {
		var url = queryUrl + encodeURIComponent(query);
		console.log(query, url);
		$.ajax({
			dataType: "jsonp",
			url: url,
			success: function(data){
				// do sth with the json
				// create an empty feature Object:
				var feature = {
					"type": "Feature",
					"properties": {
						"name": district,
						"total": [],
						"male": [],
						"female": [],
						"german": [],
						"non_german": [],
						"younger25": [],
						"Color": rgbToHex(randomColor(),randomColor(),randomColor())
					},
					"geometry": {
						"type": "Polygon",
						"coordinates": [
							[ [51.95,7.62],[51,59,7.62],[51.95,7.62] ]
						]
					}
				};
				
				// fill Object with data:
				// total values:
				for(var i=1; i<=5;i++){
					entry = data.results.bindings[i];
					feature.properties.total[i-1] = parseInt(entry.c.value);
				}
				// male values:
				for(var i=1; i<=5;i++){
					entry = data.results.bindings[i+5];
					feature.properties.male[i-1] = parseInt(entry.c.value);
				}
				// male values:
				for(var i=1; i<=5;i++){
					entry = data.results.bindings[i+10];
					feature.properties.female[i-1] = parseInt(entry.c.value);
				}
				// male values:
				for(var i=1; i<=5;i++){
					entry = data.results.bindings[i+15];
					feature.properties.german[i-1] = parseInt(entry.c.value);
				}
				// male values:
				for(var i=1; i<=5;i++){
					entry = data.results.bindings[i+20];
					feature.properties.non_german[i-1] = parseInt(entry.c.value);
				}
				// male values:
				for(var i=1; i<=5;i++){
					entry = data.results.bindings[i+25];
					feature.properties.younger25[i-1] = parseInt(entry.c.value);
				}
				
				// TODO: add coordinates
				var coordinates = [];
				
				var coords = data.results.bindings[0].d.value;
				// parse POLYGON:
				coords = coords.substring(coords.indexOf("((")+2, coords.indexOf("))"));
				
				// parse all coordinates:
				while (coords.indexOf(",")> -1) {
					// parse coordinate pair:
					var coord1 = coords.substring(0, coords.indexOf(" ")-1);
					coords = coords.substring(coords.indexOf(" ")+1);
					var coord2 = coords.substring(0, coords.indexOf(",")-1);
					coords = coords.substring(coords.indexOf(",")+1);
					var coordinate_pair = [parseFloat(coord1),parseFloat(coord2)];
					coordinates.push(coordinate_pair)
				}
				var resultarray = [];
				resultarray.push(coordinates);
				feature.geometry.coordinates = resultarray;
				
				
				// Add feature into featureCollections:
				// CASE SUBDISTRICT:
				featureCollectionSubdistricts.features.push(feature);
				// Add to bot selector:
				var option = document.createElement("option");
				option.text = feature.properties.name;
				x = document.getElementById("sel_botSubdistricts");
				x.add(option);
				
				
				
				// TODO: CASE DISTRICT:
				// Add to bot selector:
				
				// Update Map's after a district is loaded:
				updateBotMap();
				updateTopMap();
			}
		});
	}
	
	// Function which builds an example query
	function buildQuery(district) {
		var query = prefixes + "\
		SELECT DISTINCT ?b ?c ?d \n\
		WHERE { \n\
			GRAPH <http://course.introlinkeddata.org/G5> { \n\
			lodcom:"+ district +" ?b ?c. \n\
			lodcom:"+ district +" dc:coverage ?name. \n\
			?name geo:asWKT ?d. }}";
	   return query;
	}

	//example function for getting data
	function initQuery(dis) {
		query = buildQuery(dis);
		queryTriplestore(query,dis);
	}
	
	
	/**
	*  updateTopMap() updates the top map visualization regarding to the changes of the user's selection:
	*/
	function updateTopMap(){
		// TODO: create passing info for selections and forward to calculateMaximValue() and drawToMap()
		if (topDataSelection$dependency == "absolute") {
			calculateMaximumValue();
			console.log("Selected Data for top map:"+topDataSelection$districtLevel+" "+topDataSelection$category+" "+topDataSelection$dependency+" "+topDataSelection$year);} else {
			calculateChanges();
			console.log("Selected Data for top map:"+topDataSelection$districtLevel+" "+topDataSelection$category+" "+topDataSelection$dependency+" "+topDataSelection$startingYear+"-"+topDataSelection$endingYear);}
		
		// TODO: Draw Layer onto map(passing selection information forward):
		drawTopMapLayer();
		info.update();
	}

	// Top Container UI Category Selector:
	function sel_topCategory(){
		var index = document.getElementById("sel_topCategory").selectedIndex;
		// TODO: Show selected category data
		if (index==0){
			topDataSelection$category = "total";
		};
		if (index==1){
			topDataSelection$category = "male";
		};
		if (index==2){
			topDataSelection$category = "female";
		};
		if (index==3){
			topDataSelection$category = "german";
		};
		if (index==4){
			topDataSelection$category = "non_german";
		};
		if (index==5){
			topDataSelection$category = "younger25";
		};
		updateTopMap();
	}

	// Top Container UI District Level Selector:
	function sel_topDistrictLevel(){
		var index = document.getElementById("sel_topDistrictLevel").selectedIndex;
		if (index==0){
			topDataSelection$districtLevel = "districts";
		};
		if (index==1){
			topDataSelection$districtLevel = "subdistricts";
		};
		updateTopMap();
	};	
	
	// Absolute Values selected.
	function timeAbsolute(){
		var dependencyBefore = topDataSelection$dependency;
		$("#timeContainerAbsolute").show();
		$("#timeContainerRelative").hide();
		topDataSelection$dependency = "absolute";
		if (dependencyBefore!=topDataSelection$dependency) { updateTopMap(); }
	}
	
	// Relative Values selected.
	function timeRelative(){
		var dependencyBefore = topDataSelection$dependency;
		$("#timeContainerAbsolute").hide();
		$("#timeContainerRelative").show();
		topDataSelection$dependency = "relative";
		if (dependencyBefore!=topDataSelection$dependency) { updateTopMap(); }
	}

	// Timeslider for absolute values: third party bootstrap input fields:
	var sliderabs = new Slider("#sliderabs", {
		id: "sliderabs",
		value: 2012,
	  	ticks: [2010,2011,2012,2013,2014],
		ticks_labels: ['2010', '2011', '2012', '2013', '2014']
	});
	
	// Select a certain year while showing absolute numbers:
	sliderabs.on("change", function(){
		topDataSelection$year = sliderabs.getValue();
		updateTopMap();
	});
	
	// Timeslider for relative changes: third party bootstrap input fields:
	var sliderrel = new Slider("#sliderrel", {
		id: "sliderrel",
		range:true,
		value: [2010,2012],
	  	ticks: [2010,2011,2012,2013,2014],
		ticks_labels: ['2010', '2011', '2012', '2013', '2014']
	});
	
	// Select a certain start- and ending-year while showing relative changes:
	sliderrel.on("change", function(){
		var startBefore = topDataSelection$startingYear;
		var endingBefore = topDataSelection$endingYear;

		if (sliderrel.getValue()[0] == sliderrel.getValue()[1]) {
			console.log("SLIDER SAME VALUE: " + sliderrel.getValue()[0]);
			sliderrel.setValue([startBefore, startBefore+1]);
			sliderrel._mouseup();
		}
		topDataSelection$startingYear = sliderrel.getValue()[0];
		topDataSelection$endingYear = sliderrel.getValue()[1];
		if ((startBefore != topDataSelection$startingYear) || (endingBefore != topDataSelection$endingYear)) {
			updateTopMap();
		}
	});

</script>

<!-- The following Script handles the triggers of the Bottom map User interfaces and updates the bottom map visualization -->
<script>
	
	/**
	*  updateBotMap() updates the top map visualization regarding to the chances of the user's selection:
	*/
	function updateBotMap(){
		// TODO: Update the map
		//calculateMaximumValue();
		if (botDataSelection$districtLevel=="districts") {
			console.log("Selected Data for bot map:"+botDataSelection$districtLevel+" "+botDataSelection$category+" "+botDataSelection$comparedDistricts);}
		else {
			console.log("Selected Data for bot map:"+botDataSelection$districtLevel+" "+botDataSelection$category+" "+botDataSelection$comparedSubdistricts);}
		drawBotMapLayer();
		updateChart();
	}
	
	// bot Container UI Category Selector:
	function sel_botCategory(){
		var index = document.getElementById("sel_botCategory").selectedIndex;
		if (index==0){
			botDataSelection$category = "total";
		};
		if (index==1){
			botDataSelection$category = "male";
		};
		if (index==2){
			botDataSelection$category = "female";
		};
		if (index==3){
			botDataSelection$category = "german";
		};
		if (index==4){
			botDataSelection$category = "non_german";
		};
		if (index==5){
			botDataSelection$category = "younger25";
		};
		updateBotMap();
	}

	// bot Container UI District Level Selector:
	function sel_botDistrictLevel(){
		var index = document.getElementById("sel_botDistrictLevel").selectedIndex;
		if (index==0){
			botDataSelection$districtLevel = "districts";
			$("#diagram_title_dis").show();
			$("#diagram_title_subdis").hide();
		};
		if (index==1){
			botDataSelection$districtLevel = "subdistricts";
			$("#diagram_title_dis").hide();
			$("#diagram_title_subdis").show();
		};
		updateBotMap();
	};

	// Show only the selection for districts:
	function show_districts(){
		$("#sel_dis").show();
		$("#sel_subdis").hide();
	}
	
	// Show only the selection for subdistricts:
	function show_subdistricts(){
		$("#sel_dis").hide();
		$("#sel_subdis").show();
	}
	
	// Selecting districts to compare them (add a district by clicking instead of ctrl+clicking on it):
	$("#sel_botDistricts").mousedown(function(e){
		e.preventDefault();
		var scroll = this.scrollTop;
		e.target.selected = !e.target.selected;
		this.scrollTop = scroll;
		$(this).focus();
		sel_botDistricts();
	}).mousemove(function(e){e.preventDefault()});
	
	// Change Selection information 
	function sel_botDistricts(){
		var result = [];
		var selector = document.getElementById("sel_botDistricts");
		var options = selector && selector.options;
		for (var i=0, iLen = options.length; i<iLen; i++){
			opt = options[i];
			if (opt.selected) {
				result.push(opt.value || opt.text);
			}
		}
		botDataSelection$comparedDistricts = result;
		updateBotMap();
	}
	
	// Selecting districts to compare them (add a district by clicking instead of ctrl+clicking on it):
	$("#sel_botSubdistricts").mousedown(function(e){
		e.preventDefault();
		var scroll = this.scrollTop;
		e.target.selected = !e.target.selected;
		this.scrollTop = scroll;
		$(this).focus();
		sel_botSubdistricts();
	}).mousemove(function(e){e.preventDefault()});
	
	// Change Selection information
	function sel_botSubdistricts(){
		var result = [];
		var selector = document.getElementById("sel_botSubdistricts");
		var options = selector && selector.options;
		for (var i=0, iLen = options.length; i<iLen; i++){
			opt = options[i];
			if (opt.selected) {
				result.push(opt.value || opt.text);
			}
		}
		botDataSelection$comparedSubdistricts = result;
		updateBotMap();
	}

</script>


<script>

	bounds = new L.LatLngBounds(new L.LatLng(51.815922, 7.314666), new L.LatLng(52.153459, 8.042863));
	var maximum_rounded;
	var map = L.map("map").setView([51.959264, 7.625857], 12).setMaxBounds(bounds);
	var map_bottom = L.map("mapbottom").setView([51.959264, 7.625857], 12).setMaxBounds(bounds);
	map.setZoom(map.getBoundsZoom(bounds,true));
	map_bottom.setZoom(map.getBoundsZoom(bounds,true));
	
	// OSM layer
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(self.map);
	// OSM layer
    L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(self.map_bottom);
		
	
	// Add Custom Information Control:
	var info = L.control();
	info.onAdd = function (map) {
		this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
		this.update();
		return this._div;
	};
	
	// method that we will use to update the control based on feature properties passed
	info.update = function (props) {
		if (topDataSelection$dependency=="absolute") {
			var year = topDataSelection$year - 2010;
			var employees ="<h4>";
			switch (topDataSelection$category) {
				case "total":
					employees = employees + "Total employees subject to social insurance contributions in "+(year+2010) +"</h4>"; break;
				case "male":
					employees = employees + "Male employees subject to social insurance contributions in "+(year+2010)+"</h4>"; break;
				case "female":
					employees = employees + "Female employees subject to social insurance contributions in "+(year+2010)+"</h4>"; break;
				case "german":
					employees = employees + "German employees subject to social insurance contributions in "+(year+2010)+"</h4>"; break;
				case "non_german":
					employees = employees + "Non-german employees subject to social insurance contributions in "+(year+2010)+"</h4>"; break;
				case "younger25":
					employees = employees + "Employees younger than 25 subject to social insurance contributions in "+(year+2010)+"</h4>"; break;
			}
			var info = (props? 
				'<b>' + props.name + '</b><br />' + (topDataSelection$category=="total"? props.total[year] + ' total employees in year ' + (year+2010) 
						  : (topDataSelection$category=="male"? props.male[year] + ' male employees in year ' + (year+2010) 
							: (topDataSelection$category=="female"? props.female[year] + ' female employees in year ' + (year+2010) 
								: (topDataSelection$category=="german"? props.german[year] + ' german employees in year ' + (year+2010) 
									: (topDataSelection$category=="non_german"? props.non_german[year] + ' non-german employees in year ' + (year+2010)  
										: props.younger25[year] + ' employees younger than 25 in year ' + (year+2010) 
									   )
								   )
							   )
							 )
						)
			:"<b> Hover over a district </b><br />.");
		} else {
			var startYear = topDataSelection$startingYear-2010;
			var endYear = topDataSelection$endingYear-2010;
			var change=0;
			var employees = "<h4>";
			switch (topDataSelection$category) {
				case "total": 
					employees = employees + "Changes of total employees subject to social insurance contributions from "+(startYear+2010)+" to "+ (endYear+2010) +"</h4>"; break;
				case "male":
					employees = employees + "Changes of male employees subject to social insurance contributions from "+(startYear+2010)+" to "+ (endYear+2010) +"</h4>"; break;
				case "female":
					employees = employees + "Changes of female employees subject to social insurance contributions from "+(startYear+2010)+" to "+ (endYear+2010) +"</h4>"; break;
				case "german":
					employees = employees + "Changes of german employees subject to social insurance contributions from "+(startYear+2010)+" to "+ (endYear+2010) +"</h4>"; break;
				case "non_german":
					employees = employees + "Changes of non-german employees subject to social insurance contributions from "+(startYear+2010)+" to "+ (endYear+2010) +"</h4>"; break;
				case "younger25":
					employees = employees + "Changes of employees younger than 25 subject to social insurance contributions from "+(startYear+2010)+" to "+ (endYear+2010) +"</h4>"; break;
					
			}
			var info = (props? 
				'<b>' +props.name + '</b><br />' + (topDataSelection$category=="total"? Math.round(1000*props.total[endYear]/props.total[startYear]-1000)/10 + '% change of total employees'				  : (topDataSelection$category=="male"?Math.round(1000* props.male[endYear]/props.male[startYear]-1000)/10 + '% change of male employees'
							: (topDataSelection$category=="female"? Math.round(1000*props.female[endYear]/props.female[startYear]-1000)/10 + '% change of female employees' 
								: (topDataSelection$category=="german"? Math.round(1000*props.german[endYear]/props.german[startYear]-1000)/10 + '% change of german employees'
									: (topDataSelection$category=="non_german"? Math.round(1000*props.non_german[endYear]/props.non_german[startYear]-1000)/10 + '% change of non-german employees'					: Math.round(1000*props.younger25[endYear]/props.younger25[startYear]-1000)/10 + '% change of employees younger than 25'
									   )
								   )
							   )
							 )
						)
			:"<b> Hover over a district </b><br />.");
		}
		
		
		document.getElementById("info-box").innerHTML = employees + info;
		
	};
	
	function getColor(value) {
		var color = rgbToHex(0,0,0); // BLACK as indicating an error: will not occur at release ;-)
		if (topDataSelection$dependency == "absolute") {
			var year = topDataSelection$year - 2010;
			var a = value.total[year];
			switch (topDataSelection$category){
				case "total": a = value.total[year]; break;
				case "male" : a = value.male[year]; break;
				case "female" : a = value.female[year]; break;
				case "german" : a = value.german[year]; break;
				case "non_german" : a = value.non_german[year]; break;
				case "younger25" : a = value.younger25[year]; break;
			}
			var b = Math.round(255 - 255 * (a / maximum));
			color = rgbToHex(b,b,255); 
		} else {
			var startYear = topDataSelection$startingYear - 2010;
			var endYear = topDataSelection$endingYear - 2010;
			var a = value.total[year];
			switch (topDataSelection$category){
				case "total": a = value.total[endYear]/value.total[startYear]-1; break;
				case "male" : a = value.male[endYear]/value.male[startYear]-1; break;
				case "female" : a = value.female[endYear]/value.female[startYear]-1; break;
				case "german" : a = value.german[endYear]/value.german[startYear]-1; break;
				case "non_german" : a = value.non_german[endYear]/value.non_german[startYear]-1; break;
				case "younger25" : a = value.younger25[endYear]/value.younger25[startYear]-1; break;
			}
			a=a*100;
			if (a>=0){
				var b = Math.round(255 - 255 * (a / ch_maximum));
				color = rgbToHex(b,b,255); 
			} else {
				var b = Math.round(255 - 255 * (a / ch_minimum));
				color = rgbToHex(255,b,b); 
			}
		}
		return color;
	}
	
	function calculateChanges(){
		var startYear = topDataSelection$startingYear - 2010;
		var endYear = topDataSelection$endingYear - 2010;
		if (topDataSelection$districtLevel=="districts") {
			namespace=featureCollectionDistricts;
		}else{
			namespace=featureCollectionSubdistricts;
		}
		switch (topDataSelection$category){
			case "total": ch_minimum = ch_maximum = namespace.features[0].properties.total[endYear]/namespace.features[0].properties.total[startYear]-1; break;
			case "male" : ch_minimum = ch_maximum = namespace.features[0].properties.male[endYear]/namespace.features[0].properties.male[startYear]-1; break;
			case "female" : ch_minimum = ch_maximum = namespace.features[0].properties.female[endYear]/namespace.features[0].properties.female[startYear]-1; break;
			case "german" : ch_minimum = ch_maximum = namespace.features[0].properties.german[endYear]/namespace.features[0].properties.german[startYear]-1; break;
			case "non_german" : ch_minimum = ch_maximum = namespace.features[0].properties.non_german[endYear]/namespace.features[0].properties.non_german[startYear]-1; break;
			case "younger25" : ch_minimum = ch_maximum = namespace.features[0].properties.younger25[endYear]/namespace.features[0].properties.younger25[startYear]-1; break;
		}
		for (var i=1, iLen = namespace.features.length; i<iLen; i++){
			feat = namespace.features[i];
			switch (topDataSelection$category){
				case "total":
					if (ch_minimum > feat.properties.total[endYear]/feat.properties.total[startYear]-1){
						ch_minimum = feat.properties.total[endYear]/feat.properties.total[startYear]-1;
					}
					if (ch_maximum < feat.properties.total[endYear]/feat.properties.total[startYear]-1){
						ch_maximum = feat.properties.total[endYear]/feat.properties.total[startYear]-1;
					}break;
				case "male":
					if (ch_minimum > feat.properties.male[endYear]/feat.properties.male[startYear]-1){
						ch_minimum = feat.properties.male[endYear]/feat.properties.male[startYear]-1;
					}
					if (ch_maximum < feat.properties.male[endYear]/feat.properties.male[startYear]-1){
						ch_maximum = feat.properties.male[endYear]/feat.properties.male[startYear]-1;
					}break;
				case "female":  
					if (ch_minimum > feat.properties.female[endYear]/feat.properties.female[startYear]-1){
						ch_minimum = feat.properties.female[endYear]/feat.properties.female[startYear]-1;
					}
					if (ch_maximum < feat.properties.female[endYear]/feat.properties.female[startYear]-1){
						ch_maximum = feat.properties.female[endYear]/feat.properties.female[startYear]-1;
					}break;
				case "german":  
					if (ch_minimum > feat.properties.german[endYear]/feat.properties.german[startYear]-1){
						ch_minimum = feat.properties.german[endYear]/feat.properties.german[startYear]-1;
					}
					if (ch_maximum < feat.properties.german[endYear]/feat.properties.german[startYear]-1){
						ch_maximum = feat.properties.german[endYear]/feat.properties.german[startYear]-1;
					}break;
				case "non_german":  
					if (ch_minimum > feat.properties.non_german[endYear]/feat.properties.non_german[startYear]-1){
						ch_minimum = feat.properties.non_german[endYear]/feat.properties.non_german[startYear]-1;
					}
					if (ch_maximum < feat.properties.non_german[endYear]/feat.properties.non_german[startYear]-1){
						ch_maximum = feat.properties.non_german[endYear]/feat.properties.non_german[startYear]-1;
					}break;
				case "younger25":  
					if (ch_minimum > feat.properties.younger25[endYear]/feat.properties.younger25[startYear]-1){
						ch_minimum = feat.properties.younger25[endYear]/feat.properties.younger25[startYear]-1;
					}
					if (ch_maximum < feat.properties.younger25[endYear]/feat.properties.younger25[startYear]-1){
						ch_maximum = feat.properties.younger25[endYear]/feat.properties.younger25[startYear]-1;
					}break;
			}
		}
		ch_maximum = ch_maximum*100;
		ch_minimum = ch_minimum*100;
		maximum_rounded = Math.ceil(ch_maximum);
		minimum_rounded = Math.floor(ch_minimum);
		if (maximum_rounded <= 0) maximum_rounded = "-0";
		if (minimum_rounded >= 0) minimum_rounded = "-0";
		
		document.getElementById("legend-top-max").innerHTML = "+" + maximum_rounded+"%";
		document.getElementById("legend-top-mid").innerHTML = 0;
		document.getElementById("legend-top-min").innerHTML = minimum_rounded+"%";
		document.getElementById("img_legend").src = "pictures/legend_top_relative.png";
	}
	
	function calculateMaximumValue() {
		var year = topDataSelection$year - 2010;
		if (topDataSelection$districtLevel=="districts"){
			namespace = featureCollectionDistricts;
		} else {
			namespace = featureCollectionSubdistricts;
		}
		switch (topDataSelection$category){
			case "total": maximum = namespace.features[0].properties.total[year]; break;
			case "male" : maximum = namespace.features[0].properties.male[year]; break;
			case "female" : maximum = namespace.features[0].properties.female[year]; break;
			case "german" : maximum = namespace.features[0].properties.german[year]; break;
			case "non_german" : maximum = namespace.features[0].properties.non_german[year]; break;
			case "younger25" : maximum = namespace.features[0].properties.younger25[year]; break;
		}
		for (var i=1, iLen = namespace.features.length; i<iLen; i++){
			feat = namespace.features[i];
			switch (topDataSelection$category){
				case "total":
					if (maximum < feat.properties.total[year]){
						maximum = feat.properties.total[year];
					}break;
				case "male":
					if (maximum < feat.properties.male[year]){
						maximum = feat.properties.male[year];
					}break;
				case "female": 
					if (maximum < feat.properties.female[year]){
						maximum = feat.properties.female[year];
					}break;
				case "german": 
					if (maximum < feat.properties.german[year]){
						maximum = feat.properties.german[year];
					}break;
				case "non_german": 
					if (maximum < feat.properties.non_german[year]){
						maximum = feat.properties.non_german[year];
					}break;
				case "younger25": 
					if (maximum < feat.properties.younger25[year]){
						maximum = feat.properties.younger25[year];
					}break;
			}
		}
		console.log("maximum set to: "+maximum);
		var digits = maximum.toString().length;
		maximum_rounded = Math.ceil((maximum%Math.pow(10,digits-1)/Math.pow(10,digits-2)))*Math.pow(10,digits-2) + Math.floor(maximum/Math.pow(10,digits-1))*Math.pow(10,digits-1);
		console.log(maximum + " gerundet: "+ maximum_rounded);
		maximum = maximum_rounded;
		document.getElementById("legend-top-max").innerHTML = maximum_rounded;
		document.getElementById("legend-top-mid").innerHTML = "";
		document.getElementById("legend-top-min").innerHTML = 0;
		document.getElementById("img_legend").src = "pictures/legend_top_absolute.png";
	}
	
	function randomColor(){
		return Math.floor(Math.random()*200);
	}
	
	function rand(){
		return Math.floor(Math.random()*3000);
	}
	
	colorArray = [
		[rgbToHex(255,255,255)], // index 0 never used: Color WHITE for indicating an error. Won't happen when released ;-)
		[rgbToHex(70,70,220)],
		[rgbToHex(70,220,70)],
		[rgbToHex(220,70,70)],
		[rgbToHex(250,250,0)],
		[rgbToHex(180,100,100)],
		[rgbToHex(270,10,10)],
		[rgbToHex(255,106,0)]
	]
	
	// FeatureCollection containing all districts.
	var featureCollectionDistricts = {
		"type" : "FeatureCollection",
		"properties": {
			"districtLevel": "districts"
		},
		"features": [
			
			{"type": "Feature",
			"properties": {
				"name": "Xmple District 1",
				"total": [rand(), rand(), rand(), rand(), rand()],
				"male": [rand(), rand(), rand(), rand(), rand()],
				"female": [rand(), rand(), rand(), rand(), rand()],
				"german": [rand(), rand(), rand(), rand(), rand()],
				"non_german": [rand(), rand(), rand(), rand(), rand()],
				"younger25": [rand(), rand(), rand(), rand(), rand()],
				"Color": rgbToHex(220,70,70)
			},
			"geometry": {
				"type": "Polygon", 
				"coordinates": [ [
					[ 7.639498, 51.974966 ], [ 7.595872, 51.985243 ], [ 7.594468, 51.941393 ], [ 7.60281, 51.93594 ]
				]]
			}},
			{"type": "Feature",
			"properties": {
				"name": "Xmple District 2",
				"total": [rand(), rand(), rand(), rand(), rand()],
				"male": [rand(), rand(), rand(), rand(), rand()],
				"female": [rand(), rand(), rand(), rand(), rand()],
				"german": [rand(), rand(), rand(), rand(), rand()],
				"non_german": [rand(), rand(), rand(), rand(), rand()],
				"younger25": [rand(), rand(), rand(), rand(), rand()],
				"Color": rgbToHex(250,250,0)
			},
			"geometry": {
				"type": "Polygon", 
				"coordinates": [ [
					[ 7.639498, 51.974966 ], [ 7.60281, 51.93594 ], [ 7.66281, 51.96 ], [ 7.64281, 51.98 ]
				]]
			}}
			
		]
	}
	
	geojsonLayer = L.geoJson(featureCollectionDistricts, {
		style: function(Feature) {
				return {
						color: 'white',
						weight: 2,
						fillColor: getColor(Feature.properties),
						dashArray: '3',
						opacity: 0.8,
						fillOpacity: 0.5
					};
				}
	});
	
	function drawTopMapLayer(){
		if (!drawnFirstTime) {
			map.removeLayer(geojsonLayer);
		}
		if (topDataSelection$districtLevel=="districts"){
			geojsonLayer = L.geoJson(featureCollectionDistricts, {
				style: function(Feature) {
					return {
							color: 'white',
							weight: 2,
							fillColor: window["getColor"](Feature.properties),
							dashArray: '3',
							opacity: 0.8,
							fillOpacity: 0.7
						};
					},
					onEachFeature: onEachFeature
				}
			);
		} else {
			geojsonLayer = L.geoJson(featureCollectionSubdistricts, {
				style: function(Feature) {
					return {
							color: 'white',
							weight: 2,
							fillColor: window["getColor"](Feature.properties),
							dashArray: '3',
							opacity: 0.8,
							fillOpacity: 0.7
						};
					},
					onEachFeature: onEachFeature
				}
			);
		}
		geojsonLayer.addTo(map);
		drawnFirstTime = false;
	}
	
	function highlightFeature(e) {
		var layer = e.target;
	
		layer.setStyle({
			weight: 5,
			color: '#666',
			dashArray: '',
			fillOpacity: 0.7
		});
		
		info.update(layer.feature.properties);
	}
	
	function resetHighlight(e) {
		geojsonLayer.resetStyle(e.target);
		info.update();
	}
	
	function zoomToFeature(e) {
		map.fitBounds(e.target.getBounds());
	}
	
	function onEachFeature(feature, layer) {
		layer.on({
			mouseover: highlightFeature,
			mouseout: resetHighlight,
			click: zoomToFeature
		});
	}
	
	function updateChart(){
		console.log("updating Linechart...");
		delete data.datasets;
		data.datasets = [];
		if (botDataSelection$districtLevel=="districts"){
			for (var i=0, iLen = featureCollectionDistricts.features.length; i<iLen; i++){
				feat = featureCollectionDistricts.features[i];
				for (var j=0, jLen = botDataSelection$comparedDistricts.length; j<jLen; j++){
					name = botDataSelection$comparedDistricts[j];
					if (name==feat.properties.name) {
						switch (botDataSelection$category){
							case "total":
								category = feat.properties.total; break;
							case "male":
								category = feat.properties.male; break;
							case "female":
								category = feat.properties.female; break;
							case "german":
								category = feat.properties.german; break;
							case "non_german":
								category = feat.properties.non_german; break;
							case "younger25":
								category = feat.properties.younger25; break;
						}
						data.datasets.push( {
							label: name,
							fill: false,
							backgroundColor: feat.properties.Color,
							borderColor:  feat.properties.Color,
							pointBorderColor: feat.properties.Color,
							pointBackgroundColor: "#fff",
							pointBorderWidth: 1,
							pointHoverRadius: 5,
							pointHoverBackgroundColor: feat.properties.Color,
							pointHoverBorderColor: feat.properties.Color,
							pointHoverBorderWidth: 2,
							data: category
						})
					}
				}
			}
		} else {
			for (var i=0, iLen = featureCollectionSubdistricts.features.length; i<iLen; i++){
				feat = featureCollectionSubdistricts.features[i];
				for (var j=0, jLen = botDataSelection$comparedSubdistricts.length; j<jLen; j++){
					name = botDataSelection$comparedSubdistricts[j];
					if (name==feat.properties.name) {
						switch (botDataSelection$category){
							case "total":
								category = feat.properties.total; break;
							case "male":
								category = feat.properties.male; break;
							case "female":
								category = feat.properties.female; break;
							case "german":
								category = feat.properties.german; break;
							case "non_german":
								category = feat.properties.non_german; break;
							case "younger25":
								category = feat.properties.younger25; break;
						}
						data.datasets.push( {
							label: name,
							fill: false,
							backgroundColor: feat.properties.Color,
							borderColor:  feat.properties.Color,
							pointBorderColor: feat.properties.Color,
							pointBackgroundColor: "#fff",
							pointBorderWidth: 1,
							pointHoverRadius: 5,
							pointHoverBackgroundColor: feat.properties.Color,
							pointHoverBorderColor: feat.properties.Color,
							pointHoverBorderWidth: 2,
							data: category
						})
					}
				}
			}
		}
		// Get the context of the canvas element we want to select
		var ctx = document.getElementById("myChart").getContext("2d");
		var myBarChart = new Chart(ctx, { type: 'bar', data:data, options: {}});
		document.getElementById("legend").innerHTML = myBarChart.generateLegend();
	}
	
	drawnFirstTimeBot = true;	
	
	function getSelectionColor(district){
		var name = district.properties.name;
		if (botDataSelection$districtLevel=="districts"){
			for (var i=0, iLen = botDataSelection$comparedDistricts.length; i<iLen; i++){
				var sel_dis = botDataSelection$comparedDistricts[i];
				if (name==sel_dis){
					return district.properties.Color;}
			}
		} else {
			for (var i=0, iLen = botDataSelection$comparedSubdistricts.length; i<iLen; i++){
				var sel_dis = botDataSelection$comparedSubdistricts[i];
				if (name==sel_dis){
					return district.properties.Color;}
			}
		}
		return rgbToHex(185,230,230);
	}
	
	geojsonLayerBot = L.geoJson(featureCollectionDistricts, {
		style: function(Feature) {
				return {
						color: 'white',
						weight: 2,
						fillColor: getSelectionColor(Feature),
						dashArray: '3',
						opacity: 0.8,
						fillOpacity: 0.5
					};
				}
	});
	
	function selectDistrict(e) {
		var layer = e.target;
		var district = layer.feature;
		console.log(layer.feature.properties.name);
		if (botDataSelection$districtLevel=="districts") { 
			namespace = botDataSelection$comparedDistricts;
			var optionlist = document.getElementById('sel_botDistricts'); }
		else { 
			namespace = botDataSelection$comparedSubdistricts
			var optionlist = document.getElementById('sel_botSubdistricts'); }
		
		var districtWasSelected = false;
		for (var i=0, iLen = namespace.length; i<iLen; i++){
			if (district.properties.name == namespace[i]){
				namespace.splice(i,1);
				districtWasSelected = true;
				// unselect it in Selector as well
				for (var option = 0; option < optionlist.length; option++ ){
					if (optionlist[option].text == district.properties.name){
						optionlist[option].selected = false;
						break;
					}
				}
			}
		}
		if (!districtWasSelected) {
			namespace.push(district.properties.name);
			// select it in Selector as well
			for (var option = 0; option < optionlist.length; option++ ){
				if (optionlist[option].text == district.properties.name){
					optionlist[option].selected = true;
					break;
				}
			}
		}
		updateBotMap();
	}
	
	function onEachFeatureBot(feature, layer) {
		layer.on({
			click: selectDistrict
		});
	}
	
	function drawBotMapLayer(){
		if (!drawnFirstTimeBot) {
			map_bottom.removeLayer(geojsonLayerBot);
		}
		if (botDataSelection$districtLevel=="districts"){
			geojsonLayerBot = L.geoJson(featureCollectionDistricts, {
				style: function(Feature) {
					return {
							color: 'white',
							weight: 2,
							fillColor: getSelectionColor(Feature),
							dashArray: '3',
							opacity: 0.8,
							fillOpacity: 0.7
						};
					},
					onEachFeature: onEachFeatureBot
				}
			);
		} else {
			geojsonLayerBot = L.geoJson(featureCollectionSubdistricts, {
				style: function(Feature) {
					return {
							color: 'white',
							weight: 2,
							fillColor: getSelectionColor(Feature),
							dashArray: '3',
							opacity: 0.8,
							fillOpacity: 0.7
						};
					},
					onEachFeature: onEachFeatureBot
				}
			);
		}
		geojsonLayerBot.addTo(map_bottom);
		drawnFirstTimeBot = false;
	}
	
	
	$("#timeContainerRelative").hide();
	$("#sel_subdis").hide();
	
</script>


</html>